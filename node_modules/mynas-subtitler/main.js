var _ = require("lodash");
var oThrough = require("through2");
var oSubtitler = require("subtitler");
var oTransform = new require('stream').Transform({ objectMode: true });


function getSubtitles(oParams) {

    var sLang = oParams.lang;


    oTransform._transform = function(oInput, encoding, done) {

        console.log("input", oInput);

        var oStream = this;

        var oModuleData = {
            "count": 0,
            "downloaded": false,
            "found": false
        };


        /*if (oInput.checkSubtitles.exists === true) {
            oInput["subtitle"] = oModuleData;
            oStream.push(oInput);

            done();

            return;
        }
        */


        //Connect :
        oSubtitler
            .api
            .login()
            .then(function(sToken) {


                //Search subtitle:
                oSubtitler
                    .api
                    .searchForTitle(sToken, sLang, oInput.name)
                    .then(function(aResults, text) {

                        if (aResults.length === 0) {

                            done();

                        } else {

                            var oSubtitle = _.maxBy(aResults, "SubDownloadsCnt");

                            //console.log(oSubtitle);

                            oModuleData.found = true;
                            oModuleData.serie = oSubtitle.MovieName;
                            oModuleData.season = oSubtitle.SeriesSeason;
                            oModuleData.episode = oSubtitle.SeriesEpisode;
                            oModuleData.count = parseInt(oSubtitle.SubDownloadsCnt);

                            //Download subtitle :
                            oSubtitler
                                .downloader
                                .download([oSubtitle], 1, oInput.path, function(res) {

                                    oModuleData.downloaded = true;

                                    oInput["subtitle"] = oModuleData;
                                    oStream.push(oInput);

                                    done();

                                }.bind(this));

                        }
                    });
            });
    };



    return oTransform;


}


module.exports = getSubtitles;
